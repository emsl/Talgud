<h1>Registreeri talgu</h1>

<% semantic_form_for @event do |f| %>
  <% f.inputs do %>
    <%= f.input :event_type, :include_blank => false %>
    <%= f.input :name %>
    <%= f.input :location_address_street, :input_html => {:rows => 4} %>
    <%= f.input :meta_aim_description, :input_html => {:rows => 4} %>
    <%= f.input :meta_job_description, :input_html => {:rows => 4} %>
    <%= f.input :max_participants %>
    <%= f.input :begins_at %>
    <%= f.input :ends_at %>
    <%= f.input :meta_bring_with_you, :input_html => {:rows => 4} %>
    <%= f.input :meta_provided_for_participiants, :input_html => {:rows => 4} %>
    <%= f.input :meta_subject_info, :input_html => {:rows => 4} %>
    <!--
      Vahele siia:
      * Talgujuht, telefon, epost
      * Keeled mida talgujuht räägib
    -->
    <%= f.input :gathering_location, :input_html => {:rows => 4} %>
    <%= f.input :gathering_time %>
    <%= f.input :notes, :input_html => {:rows => 4} %>
    <%= f.input :latitude %>
    <%= f.input :longitude %>
  <% end %>

  <div id="map" style="height: 400px; margin-bottom: 20px; margin-left: 25%;"></div>
  
  <%= f.buttons %>
<% end %>
  
<script src="http://maps.google.com/maps/api/js?sensor=false" type="text/javascript"></script>
<script type="text/javascript" charset="utf-8">

  var center = new google.maps.LatLng(58.564, 25.729);
  var map, marker;

  function showMap(latitude, longitude) {
      map = new google.maps.Map(document.getElementById('map'), {
          zoom: 7, scrollwheel: false, center: center, mapTypeId: google.maps.MapTypeId.HYBRID
      });
      
      marker = new google.maps.Marker({position: center, map: map, draggable: true});

      google.maps.event.addListener(marker, 'drag', function() {
          $('#event_latitude').val(marker.position.lat());
          $('#event_longitude').val(marker.position.lng());
      });
      
      function centerMap(latlng, zoom) {
          map.setCenter(latlng);
          map.setZoom(zoom);
          marker.setPosition(latlng);
      }

      // Try to determine user location unless it is already known.
      if (latitude && longitude) {
          center.lat = latitude;
          center.lng = longitude;
          centerMap(center);
      } else if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
              centerMap(new google.maps.LatLng(position.coords.latitude, position.coords.longitude), 10);
          }, function() {});
      } else if (google.gears) {
          var geo = google.gears.factory.create('beta.geolocation');
          geo.getCurrentPosition(function(position) {
              centerMap(new google.maps.LatLng(position.latitude, position.longitude), 10);
          }, function() {});
      }
  }
  
  showMap($('#event_latitude').val(), $('#event_longitude').val());
</script>